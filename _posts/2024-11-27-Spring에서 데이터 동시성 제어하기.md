---
title: "[Spring/DB] Springì—ì„œ ë°ì´í„° ë™ì‹œì„± ì œì–´í•˜ê¸°"
date: 2024-11-26 08:22:23 +09:00
categories: [CS, DB]
tags:
  [
    Database,
    DB,
    Lock,
    ë¹„ê´€ì  ë½,
    ë‚™ê´€ì  ë½,
    Optimistic Lock,
    Pessimistic Lock,
    Transaction,
    ACID,
    COMMIT,
    ROLLBACK,
    MySQL,
  ]
---

# ì„œë¡ 

[DB Lock](https://longnh214.github.io/posts/Lock/) í¬ìŠ¤íŒ…ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë™ì‹œì„± ì²˜ë¦¬ë¥¼ ìœ„í•œ Lockì— ëŒ€í•´ ê³µë¶€í–ˆë‹¤. ë¿ë§Œ ì•„ë‹ˆë¼ ê³µìœ  ë½, ë°°íƒ€ ë½ê³¼ ê°™ì´ ë¸”ë¡œí‚¹ê³¼ ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¡°ê±´ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

Spring Framework ê°œë°œ í™˜ê²½ì—ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œì˜ Lock ê¸°ë²•ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œì˜ Lock ê¸°ë²•, ê·¸ë¦¬ê³  Spring ë‚´ì—ì„œ ì§€ì›í•˜ëŠ” Lock ê¸°ë²•ì— ëŒ€í•´ ê³µë¶€í•´ë³´ê³ ì í•œë‹¤.

## ë‚™ê´€ì  ë½

> - ë‚™ê´€ì  ë½ì€ ë°ì´í„°ì˜ ìˆ˜ì • ì¶©ëŒì´ ê±°ì˜ ë°œìƒí•˜ì§€ ì•Šì„ ê²ƒì´ë¼ê³  ë‚™ê´€ì ìœ¼ë¡œ ê°€ì •í•˜ëŠ” ë°©ë²•ì´ë‹¤.  
> - ë°ì´í„°ì˜ ì¼ê´€ì„±, ì •í•©ì„± ë³´ë‹¤ ì„±ëŠ¥ ìœ„ì£¼ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ëœë‹¤.  
> - ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì˜ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ê³ , DBì˜ Lock ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ë™ì‹œì„±ì„ ì œì–´í•œë‹¤.  
> - Spring Data JPAì—ì„œëŠ” `@Version` ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ì„œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

### Entity

```java
import ...

@Entity
public class SampleEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long quantity;

    @Version
    private Long version;

    public void decrease(final Long quantity) {
        if (this.quantity - quantity < 0) {
            throw new RuntimeException("ì¬ê³ ëŠ” 0ê°œ ë¯¸ë§Œì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        this.quantity -= quantity;
    }
}
```

> - ìš°ì„  ë‚™ê´€ì  ë½ì„ ì ìš©í•˜ë ¤ë©´, Entityì— ë©¤ë²„ ë³€ìˆ˜ë¡œ `@Version` ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í•œ `version`ì„ ì„ ì–¸í•´ì•¼í•œë‹¤.  
> - í•´ë‹¹ ë ˆì½”ë“œê°€ ì—…ë°ì´íŠ¸ ë  ë•Œë§ˆë‹¤ `version` ê°’ì´ 1ì”© ì˜¬ë¼ê°„ë‹¤.

### Repository

```java
import ...

@Repository
public interface SampleEntityRepository extends JpaRepository<SampleEntity, Long> {

    @Lock(LockModeType.OPTIMISTIC)
    @Query("select s from SampleEntity s where s.id = :id")
    @Transactional
    SampleEntity findByIdWithOptimisticLock(@Param("id") Long id);
}
```

> ë‚™ê´€ì  ë½ì„ ì´ìš©í•œ ì¡°íšŒë¥¼ í•˜ë„ë¡ Repositoryì— `@Lock(LockModeType.OPTIMISTIC)` ì–´ë…¸í…Œì´ì…˜ê³¼ JPQL Queryë¥¼ ì¶”ê°€í•œ select ì¡°íšŒ í•¨ìˆ˜ë¥¼ ì„ ì–¸í•´ì£¼ì—ˆë‹¤.

### Service

```java
import ...

@Service
@RequiredArgsConstructor
public class SampleEntityService {
    private final SampleEntityRepository sampleEntityRepository;

    @Transactional
    public void updateOptimisticSampleEntity(Long id){
        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithOptimisticLock(id);
        sampleEntity.decrease(1L);

        sampleEntityRepository.saveAndFlush(sampleEntity);
    }
}
```

> `updateOptimisticSampleEntity` ë©”ì†Œë“œì—ì„œ ìˆ˜ëŸ‰ì„ ê°ì†Œí•˜ëŠ” ë¡œì§ì„ ì‘ì„±í–ˆë‹¤.

### Facade

```java
import ...

@Component
@RequiredArgsConstructor
public class SampleEntityFacade {
    private final SampleEntityService sampleEntityService;

    public void updateEntityOptimistic(Long id) throws InterruptedException {
        int retryCount = 0;
        int maxRetry = 5; // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜

        while (retryCount < maxRetry) {
            try {
                sampleEntityService.updateOptimisticSampleEntity(id);
                break; // ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë©´ ë°˜ë³µ ì¢…ë£Œ
            } catch (Exception e) {
                retryCount++;
                System.out.println("ë‚™ê´€ì  ë½ ì¶©ëŒ ë°œìƒ, ì¬ì‹œë„: " + retryCount);
                if (retryCount >= maxRetry) {
                    throw e;
                }
                Thread.sleep(50); // ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
            }
        }
    }
}
```

> - ë‚™ê´€ì  ë½ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì˜ ë½ì´ ì•„ë‹Œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ë½ì´ê¸° ë•Œë¬¸ì— ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ Entityì˜ `decrease()`ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ version ì¶©ëŒë¡œ ì¸í•´ ì›í•˜ëŠ” ë§Œí¼ ìˆ˜ëŸ‰ì˜ ê°ì†Œê°€ ì¼ì–´ë‚˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤.  
> - ì¶©ëŒì´ ë°œìƒí•  ê²½ìš° ì•„ë˜ì™€ ê°™ì´ `OptimisticLockException`ì´ ë°œìƒí•˜ëŠ”ë°, ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì¬ì‹œë„ ë¡œì§ì„ Facade í´ë˜ìŠ¤ë¥¼ í†µí•´ ì‘ì„±í–ˆë‹¤.

<img width="878" alt="OptimisticLockException" src="https://github.com/user-attachments/assets/b1f0fdcb-4883-45b5-8d7b-1bb673f747fb">

### Test

```java
import ...

import static ...

@SpringBootTest
class SampleEntityServiceTest {

    @Autowired
    private SampleEntityRepository sampleEntityRepository;

    @Autowired
    private SampleEntityService sampleEntityService;

    @Autowired
    private SampleEntityFacade sampleEntityFacade;

    @BeforeEach
    void setUp(){
        SampleEntity sampleEntity = new SampleEntity();
        sampleEntity.setId(1L);
        sampleEntity.setQuantity(100L);

        sampleEntityRepository.save(sampleEntity);
    }
    @AfterEach
    void tearDown() {
        sampleEntityRepository.deleteAll();
    }

    @Test
    @DisplayName("ë‚™ê´€ì  ë½ í…ŒìŠ¤íŠ¸")
    void optimisticLockTest() {
        sampleEntityService.updateOptimisticSampleEntity(1L);
    }

    @Test
    @DisplayName("ë‚™ê´€ì  ë½ ìˆœì°¨ì  í…ŒìŠ¤íŠ¸")
    void optimisticLockTestNonThread10() throws InterruptedException {
        final int threadCount = 10;

        for(int i=0;i<threadCount;i++){
            sampleEntityFacade.updateEntityOptimistic(1L);
        }

        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithOptimisticLock(1L);

        assertEquals(90L, sampleEntity.getQuantity());
    }

    @Test
    @DisplayName("ë‚™ê´€ì  ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸")
    void optimisticLockTest10() throws InterruptedException{
        final int threadCount = 10;
        final ExecutorService executorService = Executors.newFixedThreadPool(8);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);

        for(int i=0;i<threadCount;i++){
            executorService.submit(() -> {
                try{
                    sampleEntityFacade.updateEntityOptimistic(1L);
                } catch (InterruptedException | OptimisticLockException | StaleStateException e) {
                    System.out.println("Exception occurred: " + e.getMessage());
                } finally{
                    countDownLatch.countDown();
                }
            });
        }

        // ëª¨ë“  ìŠ¤ë ˆë“œ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
        countDownLatch.await();
        executorService.shutdown();

        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithOptimisticLock(1L);
        System.out.println(sampleEntity.getVersion());

        assertEquals(90L, sampleEntity.getQuantity());
    }
}
```

> í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ decrease ë¡œì§ 1ë²ˆ ì‹¤í–‰, ë°˜ë³µë¬¸ì„ í†µí•œ 10ë²ˆ ì‹¤í–‰, ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ 10ë²ˆ ì‹¤í–‰ìœ¼ë¡œ ì •í•˜ê³  ì‹¤í–‰í•´ë³´ì•˜ë‹¤.

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼

<img width="324" alt="á„‚á…¡á†¨á„€á…ªá†«á„Œá…¥á†¨á„…á…¡á†¨1á„á…¦á„‰á…³á„á…³" src="https://github.com/user-attachments/assets/55b9243d-fde1-44e4-af60-8b35ab2c050b">
<br>
<img width="414" alt="á„‚á…¡á†¨á„€á…ªá†«á„Œá…¥á†¨á„…á…¡á†¨á„‰á…®á†«á„á…¡10á„á…¦á„‰á…³á„á…³" src="https://github.com/user-attachments/assets/c1cbf98b-cd6c-4dc0-917c-4854b9cff5ac">

> ë™ì‹œì„± í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ì´ ì‹¤íŒ¨ê°€ ë°œìƒí•  ìˆ˜ë„, ì„±ê³µìœ¼ë¡œ ëë‚  ìˆ˜ë„ ìˆë‹¤.  
> ì´ìœ ëŠ” Race Condition(ê²½í•© ìƒíƒœ)ì´ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì¶©ëŒì´ ë°œìƒí•´ì„œ ì›í•˜ëŠ” versionì— ëŒ€í•œ ë°ì´í„°ê°€ ì´ë¯¸ ì—…ë°ì´íŠ¸ê°€ ëì„ ìˆ˜ë„ ìˆë‹¤.

##### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‚¬ë¡€

<img width="414" alt="ë‚™ê´€ì ë½ë™ì‹œì„±10í…ŒìŠ¤íŠ¸ì‹¤íŒ¨" src="https://github.com/user-attachments/assets/972d52d1-7d1b-492d-ae05-32b5e47c53d6">
<br>
<img width="233" alt="ë‚™ê´€ì ë½ë™ì‹œì„±10í…ŒìŠ¤íŠ¸ì‹¤íŒ¨ì‚¬ìœ " src="https://github.com/user-attachments/assets/46b3e312-e401-4fdb-bdba-8e69649fd6d1">

##### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‚¬ë¡€

<img width="355" alt="á„‚á…¡á†¨á„€á…ªá†«á„Œá…¥á†¨á„…á…¡á†¨á„ƒá…©á†¼á„‰á…µá„‰á…¥á†¼10á„á…¦á„‰á…³á„á…³ì„±ê³µ" src="https://github.com/user-attachments/assets/94833a04-1dfd-4980-94a4-fe9a43fad7d8">

## ë¹„ê´€ì  ë½

> - ë¹„ê´€ì  ë½ì€ ë°ì´í„°ì˜ ìˆ˜ì • ì¶©ëŒì´ ë¬´ì¡°ê±´ ë°œìƒí•  ê²ƒì´ë¼ê³  ë¹„ê´€ì ìœ¼ë¡œ ê°€ì •í•˜ëŠ” ë°©ë²•ì´ë‹¤.  
> - ë°ì´í„°ì˜ ì¼ê´€ì„±, ì •í•©ì„±ì´ ì¤‘ìš”í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ëœë‹¤.  
> - DBì˜ Lock ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ë™ì‹œì„±ì„ ì œì–´í•œë‹¤.  
> - Spring Data JPAì—ì„œëŠ” `@Lockì˜ ì†ì„±ì¸ LockModeType`ì„ í†µí•´ ê³µìœ  ë½, ë°°íƒ€ì  ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

ğŸ’¡ EntityëŠ” ìœ„ ë‚™ê´€ì  ë½ì—ì„œ ì´ìš©í–ˆë˜ `SampleEntity`ë¥¼ ê·¸ëŒ€ë¡œ ì´ìš©í•  ê²ƒì´ë‹¤.

### Repository

```java
import ...

@Repository
public interface SampleEntityRepository extends JpaRepository<SampleEntity, Long> {
    @Transactional
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("select s from SampleEntity s where s.id = :id")
    SampleEntity findByIdWithPessimisticLock(@Param("id") Long id);
}
```

> - `@Lock` ì–´ë…¸í…Œì´ì…˜ì˜ `LockModeType` ì˜µì…˜ì— ë”°ë¼ ì•„ë˜ì™€ ê°™ì€ Lockì´ ì ìš©ëœë‹¤.
>   - `LockModeType.PESSIMISTIC_WRITE` : ë°°íƒ€ì  ë½(`FOR UPDATE`) ì¿¼ë¦¬ ìˆ˜í–‰
>   - `LockModeType.PESSIMISTIC_READ` : ê³µìœ  ë½(`FOR SHARE`) ì¿¼ë¦¬ ìˆ˜í–‰
>   - `LockModeType.PESSIMISTIC_FORCE_INCREMENT` : ë°°íƒ€ì  ë½(`FOR UPDATE`) ì¿¼ë¦¬ì™€, version ìƒìŠ¹ì´ í˜¼í•©ëœ Lock ë°©ì‹
> - í…ŒìŠ¤íŠ¸ëŠ” `LockModeType.PESSIMISTIC_WRITE` ë°©ì‹ìœ¼ë¡œ ì§„í–‰í–ˆë‹¤.

### Service

```java
import ...

@Service
@RequiredArgsConstructor
public class SampleEntityService {
    private final SampleEntityRepository sampleEntityRepository;

    @Transactional
    public void updatePessimisticSampleEntity(Long id) throws InterruptedException{
        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithPessimisticLock(id);
        sampleEntity.decrease(1L);

        sampleEntityRepository.saveAndFlush(sampleEntity);
    }
}
```

### Test

```java
import ...

@SpringBootTest
class SampleEntityServiceTest {

    @Autowired
    private SampleEntityRepository sampleEntityRepository;

    @Autowired
    private SampleEntityService sampleEntityService;

    @Autowired
    private SampleEntityFacade sampleEntityFacade;

    @BeforeEach
    void setUp(){
        SampleEntity sampleEntity = new SampleEntity();
        sampleEntity.setId(1L);
        sampleEntity.setQuantity(100L);

        sampleEntityRepository.save(sampleEntity);
    }
    @AfterEach
    void tearDown() {
        sampleEntityRepository.deleteAll();
    }

    @Test
    @DisplayName("ë¹„ê´€ì  ë½ í…ŒìŠ¤íŠ¸")
    void pessimisticLockTest() throws InterruptedException {
        sampleEntityService.updatePessimisticSampleEntity(1L);
    }

    @Test
    @DisplayName("ë¹„ê´€ì  ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸")
    void pessimisticLockTest10() throws InterruptedException{
        final int threadCount = 10;
        final ExecutorService executorService = Executors.newFixedThreadPool(1);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);

        for(int i=0;i<threadCount;i++){
            executorService.submit(() -> {
                try{
                    sampleEntityService.updatePessimisticSampleEntity(1L);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                } finally{
                    countDownLatch.countDown();
                }
            });
        }

        // ëª¨ë“  ìŠ¤ë ˆë“œ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
        countDownLatch.await();
        executorService.shutdown();

        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithPessimisticLock(1L);

        assertEquals(10L, sampleEntity.getVersion());
        assertEquals(90L, sampleEntity.getQuantity());
    }
}
```

> - ë¹„ê´€ì  ë½ ì˜µì…˜ì„ í†µí•´ ë ˆì½”ë“œë¥¼ ì¡°íšŒí•˜ê²Œ ë˜ë©´ ì•„ë˜ ì²˜ëŸ¼ `SELECT ... FOR UPDATE` ì¿¼ë¦¬ë¥¼ í†µí•´ ì¡°íšŒí•˜ê²Œ ëœë‹¤.
> - ë¹„ê´€ì  ë½ì„ í†µí•´ ë™ì‹œì„± ì²˜ë¦¬ë¥¼ í•˜ê²Œ ë˜ë©´, ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì˜ ë°°íƒ€ì  ë½ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ë‚®ì•„ì§ˆ ìˆ˜ ìˆì§€ë§Œ ë°ì´í„°ì˜ ì •í•©ì„±ì„ ì§€í‚¬ ìˆ˜ ìˆë‹¤.

<img width="366" alt="select_for_update" src="https://github.com/user-attachments/assets/31460451-3165-4b9c-b654-1c07f57df6d4">

#### ë¹„ê´€ì  ë½ í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‚¬ë¡€

<img width="359" alt="á„‡á…µá„€á…ªá†«á„Œá…¥á†¨á„…á…¡á†¨1á„á…¦á„‰á…³á„á…³" src="https://github.com/user-attachments/assets/c3b607a0-003f-429c-b344-4760c57c4b88">

#### ë¹„ê´€ì  ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‚¬ë¡€

<img width="350" alt="á„‡á…µá„€á…ªá†«á„Œá…¥á†¨á„…á…¡á†¨á„ƒá…©á†¼á„‰á…µá„‰á…¥á†¼10á„á…¦á„‰á…³á„á…³ì„±ê³µ" src="https://github.com/user-attachments/assets/c8825c3d-7614-4d69-bdce-1d46452ebd4d">

## ë„¤ì„ë“œ ë½

> ë„¤ì„ë“œ ë½ì€ ì„ì˜ë¡œ ë½ì˜ ì´ë¦„ì„ ì„¤ì •í•˜ê³ , í•´ë‹¹ ë½ì„ ì‚¬ìš©í•´ì„œ ë™ì‹œì„±ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì˜ ë™ì‹œì„± ì œì–´ ë°©ì‹ì´ë‹¤.

ë„¤ì„ë“œ ë½ë„ ë¹„ê´€ì  ë½ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ì œì–´ë˜ëŠ” ë½ì´ë‹¤.

ì°¨ì´ì ìœ¼ë¡œëŠ”,

- Lockì„ ì„¤ì •í•˜ëŠ” ëŒ€ìƒ
  - ë¹„ê´€ì  ë½ì€ `sample_entity` í…Œì´ë¸”ì˜ ì¸ë±ìŠ¤ì— ë½ì´ ê±¸ë¦¬ê²Œ ëœë‹¤.
  - ë„¤ì„ë“œ ë½ì€ MySQLì˜ ë³„ë„ ì €ì¥ ê³µê°„ì— Lockì„ ì„¤ì •í•˜ê²Œ ëœë‹¤.
- Lockì˜ í•´ì œ ì‹œì 
  - ë¹„ê´€ì  ë½ì€ Lockì„ ê°€ì§„ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ Lockì´ í•´ì œë˜ì–´ ëŒ€ê¸°ì¤‘ì¸ íŠ¸ëœì­ì…˜ ì‘ì—…ì´ ìˆ˜í–‰ë  ìˆ˜ ìˆë‹¤.
  - ë„¤ì„ë“œ ë½ì€ íŠ¸ëœì­ì…˜ì˜ ì¢…ë£Œì™€ Lockì˜ í•´ì œ ì‹œì ì— ê´€ë ¨ ì—†ì´, ì •í•´ì§„ timeout ì‹œê°„ì´ ì§€ë‚˜ë©´ Lockì´ í•´ì œëœë‹¤.

> ë¹„ê´€ì  ë½ì€ ë¶„ì‚° ì„œë²„ í™˜ê²½ì—ì„œ ì²˜ë¦¬ë˜ì–´ì§€ê¸° ì–´ë µë‹¤ëŠ” ë‹¨ì ì´ ìˆëŠ”ë°, ë„¤ì„ë“œ ë½ì€ ë¶„ì‚° ë½ì˜ ê¸°ë²•ìœ¼ë¡œ ë§ì´ ì‚¬ìš©ëœë‹¤.  
> [ìš°ì•„í•œ ê¸°ìˆ  ë¸”ë¡œê·¸ - ë¶„ì‚° ë½ ì ìš©ê¸°](https://techblog.woowahan.com/2631/)

### Repository

```java
import ...

@Repository
public interface LockRepository extends JpaRepository<SampleEntity, Long> {

    @Query(value = "select get_lock(:key, 3000)", nativeQuery = true)
    void getLock(String key);

    @Query(value = "select release_lock(:key)", nativeQuery = true)
    void releaseLock(String key);
}
```

- getLock ë©”ì†Œë“œ : get_lock DB í•¨ìˆ˜ì— ì¸ìë¡œ keyì™€ timeout(ms)ì„ ì£¼ì–´ NamedLockì„ ì„¤ì •í•œë‹¤.
- releaseLock ë©”ì†Œë“œ : release_lock DB í•¨ìˆ˜ë¥¼ í†µí•´ í•´ë‹¹ keyì˜ NamedLockì„ í•´ì œí•œë‹¤.

### Service

```java
import ...

@Service
@RequiredArgsConstructor
public class SampleEntityService {
    private final SampleEntityRepository sampleEntityRepository;

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void decrease(Long id){
        SampleEntity sampleEntity = sampleEntityRepository.findById(id).orElseThrow(() -> new RuntimeException("Entity not found"));
        sampleEntity.decrease(1L);

        sampleEntityRepository.saveAndFlush(sampleEntity);
    }
}
```

- ë‚™ê´€ì  ë½, ë¹„ê´€ì  ë½ê³¼ ë‹¤ë¥´ê²Œ íŠ¸ëœì­ì…˜ ì „íŒŒ ì „ëµì„ `Propagation.REQUIRES_NEW`ë¡œ í•´ì„œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ íŠ¸ëœì­ì…˜ì„ ë³„ë„ë¡œ ë¶„ë¦¬í•´ì•¼í•œë‹¤.
- ë„¤ì„ë“œ ë½ì€ ë½ì˜ í•´ì œì™€ íŠ¸ëœì­ì…˜ì˜ ì»¤ë°‹ ì‹œì ì´ ê´€ë ¨ì´ ì—†ê¸° ë•Œë¬¸ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ íŠ¸ëœì­ì…˜ì„ ë³„ë„ë¡œ ë¶„ë¦¬í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì»¤ë°‹ëœ í›„ì— ë„¤ì„ë“œ ë½ì„ í•´ì œí•´ì•¼í•œë‹¤.

### Facade

```java
import ...

@Component
@RequiredArgsConstructor
public class NamedLockFacade {
    private final LockRepository lockRepository;
    private final SampleEntityService sampleEntityService;

    @Transactional
    public void updateNamedSampleEntity(Long id){
        try{
            lockRepository.getLock(id.toString());
            sampleEntityService.decrease(id);
        }finally {
            lockRepository.releaseLock(id.toString());
        }
    }
}
```

### ğŸ’¡ ë§Œì•½ Lock ì„¤ì •/í•´ì œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì¸ë‹¤ë©´?

> Thread Aì™€ Bì—ì„œ í•œ ë ˆì½”ë“œì˜ ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì„ ë™ì‹œì— ìš”ì²­í–ˆë‹¤ê³  ê°€ì •í•˜ë©´, Thread Aì—ì„œ ë„¤ì„ë“œ ë½ì„ ì„¤ì •í•˜ê³ , ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì„ ì‹¤í–‰í•œ ë’¤ì— ë„¤ì„ë“œ ë½ì„ í•´ì œí•œë‹¤.  
> ì—¬ê¸°ì„œ í•´ë‹¹ ë ˆì½”ë“œì˜ ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì„ ì‹¤í–‰í•œ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì´ ì¤‘ìš”í•˜ë‹¤. í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ ì´ë¤„ì§„ë‹¤ë©´ ë„¤ì„ë“œ ë½ í•´ì œê°€ ë§ˆì§€ë§‰ ë¡œì§ì´ê¸° ë•Œë¬¸ì— ë„¤ì„ë“œ ë½ í•´ì œ í›„ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë  ê²ƒì´ë‹¤.  
> ì´ ë•Œ Thread Bì˜ ì…ì¥ì—ì„œëŠ” ë„¤ì„ë“œ ë½ì— ì˜í•´ ë¸”ë¡œí‚¹ ìƒíƒœë¡œ ëŒ€ê¸°í•˜ê³  ìˆë‹¤ê°€, ë„¤ì„ë“œ ë½ì´ í•´ì œë˜ëŠ” ìˆœê°„ ìì‹ ì˜ ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì„ ì‹¤í–‰í•œë‹¤. í•˜ì§€ë§Œ ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì´ ì»¤ë°‹ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— Thread Aì—ì„œ ìˆ˜ëŸ‰ ê°ì†Œ ë¡œì§ì´ ì‹¤í–‰ë˜ê¸° ì „ì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê²Œ ë˜ë¯€ë¡œ ë‚™ê´€ì  ë½ì²˜ëŸ¼ ëˆ„ë½ì´ ë°œìƒí•  ê²ƒì´ë‹¤.

### Test

```java
import ...

@SpringBootTest
class NamedLockFacadeTest {
    @Autowired
    private SampleEntityRepository sampleEntityRepository;

    @Autowired
    private NamedLockFacade namedLockFacade;

    @BeforeEach
    void setUp(){
        SampleEntity sampleEntity = new SampleEntity();
        sampleEntity.setId(1L);
        sampleEntity.setQuantity(100L);

        sampleEntityRepository.save(sampleEntity);
    }
    @AfterEach
    void tearDown() {
        sampleEntityRepository.deleteAll();
    }

    @Test
    @DisplayName("ë„¤ì„ë“œ ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸")
    void namedLockTest10() throws InterruptedException {
        final int threadCount = 10;
        final ExecutorService executorService = Executors.newFixedThreadPool(8);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);

        for(int i=0;i<threadCount;i++){
            executorService.submit(() -> {
                try{
                    namedLockFacade.updateNamedSampleEntity(1L);
                } catch (Exception e) {
                    System.out.println("Exception occurred: " + e.getMessage());
                } finally{
                    countDownLatch.countDown();
                }
            });
        }

        // ëª¨ë“  ìŠ¤ë ˆë“œ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
        countDownLatch.await();
        executorService.shutdown();

        SampleEntity sampleEntity = sampleEntityRepository.findByIdWithOptimisticLock(1L);
        System.out.println(sampleEntity.getVersion());

        assertEquals(90L, sampleEntity.getQuantity());
    }
}
```

> íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ë„ 2ê°œë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

### ë„¤ì„ë“œ ë½ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‚¬ë¡€

<img width="360" alt="á„‚á…¦á„‹á…µá†·á„ƒá…³á„…á…¡á†¨á„ƒá…©á†¼á„‰á…µá„‰á…¥á†¼10á„á…¦á„‰á…³á„á…³" src="https://github.com/user-attachments/assets/1cad117b-11a6-4419-975c-91985b21ecf6">

## 3ê°€ì§€ Lock ì¥ë‹¨ì  ë¹„êµ

### ë‚™ê´€ì  ë½

- ì¥ì 
  - ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ë½ì„ ì„¤ì •í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì‘ì—…ì´ ê¸¸ì–´ì§ˆ ë•Œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ì‘ì—…ì´ ì˜í–¥ì„ ë°›ì§€ ì•Šì•„ ì„±ëŠ¥ì— ì´ì ì´ ìˆì„ ìˆ˜ ìˆë‹¤.

- ë‹¨ì 
  - `OptimisticLockException`ê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ì¬ì‹œë„ ë¡œì§ì„ êµ¬í˜„í•´ì•¼í•œë‹¤.
  - ì¬ì‹œë„ ë¡œì§ì„ íƒ€ê²Œ ë˜ë©´ ì„±ëŠ¥ì— ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆë‹¤.(ë¹ˆë²ˆí•œ ë™ì‹œ ìˆ˜ì •ì´ ë°œìƒí•˜ë©´ ì„±ëŠ¥ì— ì¢‹ì§€ ì•Šë‹¤.)

### ë¹„ê´€ì  ë½

- ì¥ì 
  - Race Condition(ê²½í•© ìƒíƒœ)ì´ ìì£¼ ì¼ì–´ë‚œë‹¤ë©´ ë‚™ê´€ì  ë½ë³´ë‹¤ ì„±ëŠ¥ì´ ì¢‹ë‹¤.
  - ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì˜ Lockì„ í†µí•´ ë™ì‹œì„±ì„ ì œì–´í•˜ê¸° ë•Œë¬¸ì— ë°ì´í„°ì˜ ì •í•©ì„±ì´ ë³´ì¥ëœë‹¤.

- ë‹¨ì 
  - ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ Lockì„ ì„¤ì •í•˜ê¸° ë•Œë¬¸ì— í•œ íŠ¸ëœì­ì…˜ ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ëë‚˜ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ì‘ì—…ë“¤ì´ ëŒ€ê¸°í•´ì•¼í•˜ë¯€ë¡œ ì„±ëŠ¥ì´ ê°ì†Œí•  ìˆ˜ ìˆë‹¤.

### ë„¤ì„ë“œ ë½

- ì¥ì 
  - ì—¬ëŸ¬ ëŒ€ì˜ ì„œë²„ê°€ ìˆì„ ë•Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
    - ë¶„ì‚° ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.
  - Lockì˜ ëŒ€ìƒì´ ë³„ë„ë¡œ Lockì„ ìœ„í•œ ê³µê°„ì— Lockì„ ì„¤ì •í•˜ê¸° ë•Œë¬¸ì— ê°™ì€ keyì˜ ë„¤ì„ë“œ ë½ì„ ì‚¬ìš©í•˜ëŠ” ì‘ì—… ì™¸ì˜ ì‘ì—…ì€ ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤.
  - ë°ì´í„° UPDATE ì‘ì—…ì´ ì•„ë‹Œ INSERT ì‘ì—…ì˜ ê²½ìš°ì—ëŠ” ê¸°ì¤€ì„ ì¡ì„ ë ˆì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ë¹„ê´€ì  ë½ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ”ë°, ì´ ë•Œ ë„¤ì„ë“œ ë½ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- ë‹¨ì 
  - íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œì— Lock í•´ì œ, ì„¸ì…˜ ê´€ë¦¬ ë“±ì„ ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘ ì²˜ë¦¬í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— êµ¬í˜„ì´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆë‹¤.

## ê²°ë¡ 

ë‚™ê´€ì  ë½ê³¼ ë¹„ê´€ì  ë½ì€ ë°ì´í„°ì˜ ìˆ˜ì • ì¶©ëŒ, Race Condition(ê²½í•© ê³¼ì •)ì˜ ë¹ˆë„ìˆ˜ì— ë§ê²Œ ì‚¬ìš©í•˜ê³ , ì„œë²„ê°€ 1ëŒ€ê°€ ì•„ë‹Œ ì—¬ëŸ¬ ëŒ€ì™€ ê°™ì€ ë¶„ì‚°ëœ ì•„í‚¤í…ì²˜ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´ ë¶„ì‚° ë½ì„ ë„¤ì„ë“œ ë½ì„ í†µí•´ êµ¬í˜„í•´ì„œ ì‚¬ìš©í•œë‹¤.  
ë¹„ê´€ì  ë½ê³¼ ë‚™ê´€ì  ë½ì„ ë” ìì„¸íˆ ë§í•˜ë©´, ì¶©ëŒì´ ìì£¼ ì¼ì–´ë‚  ê²ƒì´ë¼ê³  ì˜ˆìƒë˜ë©´ ë¹„ê´€ì  ë½ì„, ì¶©ëŒì´ ë¹ˆë²ˆí•˜ì§€ ì•Šì§€ë§Œ ë™ì‹œì„±ì„ ì§€ì¼œì•¼í•œë‹¤ë©´ ë‚™ê´€ì  ë½ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

ì´í›„ì—ëŠ” MySQLì—ì„œ ë½ì´ ì–´ë–»ê²Œ êµ¬í˜„ë˜ëŠ” ì§€ ê¹Šê²Œ ì•Œì•„ë³¼ ê²ƒì´ë‹¤.

## ì°¸ê³ 

- [ìŠ¤í”„ë§ ë™ì‹œì„± ì²˜ë¦¬ ë°©ë²•(feat. ë¹„ê´€ì  ë½, ë‚™ê´€ì  ë½, ë„¤ì„ë“œ ë½)](https://ksh-coding.tistory.com/125)
- [ë‚™ê´€ì  ë½(Optimistic Lock)ê³¼ ë¹„ê´€ì  ë½(Pessimistic Lock)ì— ëŒ€í•´](https://mozzi-devlog.tistory.com/37)